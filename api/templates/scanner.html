<!-- api/templates/scanner.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Universal QR & Barcode Scanner</title>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 18px; text-align: center; }
    #reader { margin: 0 auto; width: 640px; height: 480px; background: #000; }
    #result { margin-top: 14px; white-space: pre-wrap; text-align: left; display: inline-block; max-width: 700px; }
    .chip { display: inline-block; padding: 6px 10px; border-radius: 16px; background:#eef; margin:4px;}
    input[type=file] { margin-top: 12px; }
    a.link { color: blue; text-decoration: underline; }
  </style>
</head>
<body>
  <h1>Universal QR & Barcode Scanner</h1>
  <p>Use your webcam to scan or upload an image. Works for URLs, payment links, WiFi, vCard, phone, SMS, geo, bitcoin, or plain text.</p>

  <video id="video" width="640" height="480" autoplay muted playsinline></video>
  <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>

  <div id="result" class="card">Result will appear here...</div>

  <div style="margin-top:12px;">
    <input id="fileInput" type="file" accept="image/*">
  </div>

<script>
/* --- Classification (same heuristics client-side for instant display) --- */
function classifyText(t) {
  if (!t) return {type: "empty", payload: ""};
  const s = t.trim();

  if (/^https?:\/\//i.test(s)) return {type: "url", payload: s};
  if (s.toLowerCase().startsWith("mailto:")) return {type: "email", payload: s.slice(7)};
  if (s.toLowerCase().startsWith("tel:")) return {type: "phone", payload: s.slice(4)};
  if (/^(sms:|smsto:)/i.test(s)) return {type: "sms", payload: s};
  if (s.toUpperCase().startsWith("WIFI:")) {
    // parse simple wifi payload
    const obj = {};
    const inner = s.slice(5).replace(/;$/,'');
    inner.split(';').forEach(p => { const [k,v] = p.split(':'); if(k && v) obj[k]=v; });
    return {type: "wifi", payload: obj};
  }
  if (/^BEGIN:VCARD/i.test(s)) return {type: "vcard", payload: s};
  if (/^geo:/i.test(s)) return {type: "geo", payload: s};
  if (/^bitcoin:/i.test(s) || /^(bc1|1|3)[0-9A-Za-z]{25,34}$/.test(s)) return {type: "crypto", payload: s};
  if (/^upi:/i.test(s) || /easypaisa|paytm|alipay|upi/i.test(s)) return {type: "payment", payload: s};
  if (/^[\d\+\-\s\(\)]{6,20}$/.test(s)) return {type: "phone", payload: s};
  return {type: "text", payload: s};
}

/* --- Helpers to render result nicely --- */
function renderResult(item) {
  const container = document.createElement("div");
  container.style.padding = "8px";
  container.style.borderBottom = "1px solid #eee";

  const typeBadge = document.createElement("span");
  typeBadge.className = "chip";
  typeBadge.textContent = item.type.toUpperCase();
  container.appendChild(typeBadge);

  const content = document.createElement("div");
  content.style.marginTop = "6px";

  if (item.type === "url") {
    const a = document.createElement("a");
    a.href = item.payload;
    a.target = "_blank";
    a.className = "link";
    a.textContent = item.payload;
    content.appendChild(a);
  } else if (item.type === "wifi") {
    content.textContent = "WiFi: " + JSON.stringify(item.payload);
  } else {
    // other types: show payload and raw if present
    const pre = document.createElement("pre");
    pre.textContent = item.payload;
    content.appendChild(pre);
  }

  container.appendChild(content);
  return container;
}

function displayResults(list) {
  const res = document.getElementById("result");
  res.innerHTML = "";
  if (!list || list.length === 0) {
    res.textContent = "No QR/barcode detected yet.";
    return;
  }
  list.forEach(it => {
    const node = renderResult(it);
    res.appendChild(node);
  });
}

/* --- Live camera scanning using jsQR on frames --- */
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let localStream = null;

function startCamera() {
  navigator.mediaDevices.getUserMedia({video: { facingMode: "environment" }})
    .then(stream => {
      localStream = stream;
      video.srcObject = stream;
      video.play();
      requestAnimationFrame(tick);
    })
    .catch(err => {
      document.getElementById("result").textContent = "Camera error: " + err;
    });
}

function tick() {
  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "attemptBoth" });
    if (code) {
      const classified = classifyText(code.data);
      displayResults([classified]);
      // optionally, stop camera after detection:
      // stopCamera();
      // or continue scanning - we show live updates
    }
  }
  requestAnimationFrame(tick);
}

function stopCamera() {
  if (localStream) {
    localStream.getTracks().forEach(t => t.stop());
    localStream = null;
  }
}

/* --- File upload: we'll POST to server which uses pyzbar for robust detection --- */
document.getElementById("fileInput").addEventListener("change", function(e) {
  const file = this.files[0];
  if (!file) return;
  const fd = new FormData();
  fd.append("file", file);

  fetch("/upload_qr/", { method: "POST", body: fd })
    .then(r => r.json())
    .then(data => {
      if (data.error) {
        document.getElementById("result").textContent = "Upload error: " + data.error;
        return;
      }
      if (!data.results || data.results.length === 0) {
        document.getElementById("result").textContent = "No QR/barcode found in image.";
        return;
      }
      // server already classified each result (raw + type + payload)
      displayResults(data.results);
    })
    .catch(err => {
      document.getElementById("result").textContent = "Upload fetch error: " + err;
    });
});

/* start camera on page load */
startCamera();
</script>
</body>
</html>
